{% extends "/admin/layout/index.html" %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.2/dist/bootstrap-table.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin/seksikonservasi.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.21.2/dist/bootstrap-table.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.21.2/dist/extensions/export/bootstrap-table-export.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://rawgit.com/hhurz/tableExport.jquery.plugin/master/tableExport.min.js"></script>

<div class="seksikonservasi-container">
    <div class="seksikonservasi-title">
        <i class="fa-solid fa-building"></i>
        <span>Kelola Seksi Konservasi Wilayah</span>
    </div>

    <!-- Tombol Tambah -->
    <div class="seksikonservasi-button-container">
        <button class="seksikonservasi-add-btn" data-toggle="modal" data-target="#tambahSeksiModal">
            Tambah
        </button>
    </div>

    <!-- TABLE -->
    <div class="seksikonservasi-table-responsive">
        <table id="seksiTable" class="table table-seksikonservasi" data-toggle="table" data-search="true"
            data-show-columns="true" data-show-refresh="true" data-pagination="true"
            data-page-list="[5, 10, 20, 50, 100]" data-show-export="true" data-export-types="['excel','csv','pdf']"
            data-export-options='{"fileName": "data-seksi-konservasi"}' data-pagination-pre-text="‹"
            data-pagination-next-text="›">
            <thead class="thead-dark">
                <tr>
                    <th>No</th>
                    <th>Nama</th>
                    <th>Kepala Resor</th>
                    <th>Kode Resor</th>
                    <th>Alamat</th>
                    <th>Kabupaten</th>
                    <th data-visible="false">Telepon</th>
                    <th data-visible="false">Email</th>
                    <th data-visible="false">Wilayah Kerja</th>
                    <th>Peta Lokasi</th>
                    <th>Status</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
                {% for unit in data %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ unit.nama }}</td>
                    <td>{{ unit.kepala_resor or '-' }}</td>
                    <td>{{ unit.kode_resor or '-' }}</td>
                    <td>{{ unit.alamat[:40] }}...</td>
                    <td>{{ unit.kabupaten }}</td>
                    <td>{{ unit.telepon }}</td>
                    <td>{{ unit.email }}</td>
                    <td>{{ unit.wilayah_kerja or '-' }}</td>
                    <td>
                        {% if unit.peta_lokasi %}
                        <a href="{{ unit.peta_lokasi }}" target="_blank">Lihat</a>
                        {% else %}-{% endif %}
                    </td>
                    <td>{{ unit.status }}</td>
                    <td>
                        <div class="seksikonservasi-action-buttons">
                            <button class="seksikonservasi-btn-circle edit" data-id="{{ unit.id }}"
                                data-nama="{{ unit.nama }}" data-kepala="{{ unit.kepala_resor }}"
                                data-kode="{{ unit.kode_resor }}" data-alamat="{{ unit.alamat }}"
                                data-kabupaten="{{ unit.kabupaten }}" data-telepon="{{ unit.telepon }}"
                                data-email="{{ unit.email }}" data-wilayah="{{ unit.wilayah_kerja }}"
                                data-peta="{{ unit.peta_lokasi }}" data-status="{{ unit.status }}">
                                <i class="fa fa-edit"></i>
                            </button>

                            <form action="{{ url_for('delete_unit_kerja', id=unit.id) }}" method="POST"
                                class="delete-form d-inline">
                                <button type="button" class="seksikonservasi-btn-circle delete"><i
                                        class="fa fa-trash"></i></button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- =======================
     MODAL TAMBAH SEKS KONSERVASI
======================= -->
<div class="modal fade" id="tambahSeksiModal" tabindex="-1" aria-labelledby="tambahSeksiLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content p-3">
            <div class="modal-header">
                <h5 class="modal-title">Tambah Seksi Konservasi</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <form id="formTambahSeksi" method="POST" action="{{ url_for('create_unit_kerja') }}">
                <div class="modal-body">
                    <div class="form-group"><label>Nama</label><input type="text" name="nama" class="form-control"
                            required></div>
                    <div class="form-group"><label>Kepala Resor</label><input type="text" name="kepala_resor"
                            class="form-control"></div>
                    <div class="form-group"><label>Kode Resor</label><input type="text" name="kode_resor"
                            class="form-control"></div>
                    <div class="form-group"><label>Alamat</label><textarea name="alamat" class="form-control"
                            required></textarea></div>
                    <div class="form-group"><label>Kabupaten</label><input type="text" name="kabupaten"
                            class="form-control" required></div>
                    <div class="form-group"><label>Wilayah Kerja</label><input type="text" name="wilayah_kerja"
                            class="form-control"></div>
                    <div class="form-group"><label>Telepon</label><input type="text" name="telepon" class="form-control"
                            required></div>
                    <div class="form-group"><label>Email</label><input type="email" name="email" class="form-control"
                            required></div>
                    <div class="form-group"><label>Peta Lokasi</label><textarea name="peta_lokasi"
                            class="form-control"></textarea></div>
                    <div class="form-group">
                        <label>Status</label>
                        <select name="status" class="form-control">
                            <option value="aktif" selected>Aktif</option>
                            <option value="nonaktif">Nonaktif</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Simpan</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- =======================
     MODAL EDIT SEKS KONSERVASI
======================= -->
<div class="modal fade" id="editSeksiModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content p-3">
            <div class="modal-header">
                <h5 class="modal-title">Edit Seksi Konservasi</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <form id="formEditSeksi" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="id" id="edit_id">
                    <div class="form-group"><label>Nama</label><input type="text" name="nama" id="edit_nama"
                            class="form-control" required></div>
                    <div class="form-group"><label>Kepala Resor</label><input type="text" name="kepala_resor"
                            id="edit_kepala" class="form-control"></div>
                    <div class="form-group"><label>Kode Resor</label><input type="text" name="kode_resor" id="edit_kode"
                            class="form-control"></div>
                    <div class="form-group"><label>Alamat</label><textarea name="alamat" id="edit_alamat"
                            class="form-control" required></textarea></div>
                    <div class="form-group"><label>Kabupaten</label><input type="text" name="kabupaten"
                            id="edit_kabupaten" class="form-control" required></div>
                    <div class="form-group"><label>Wilayah Kerja</label><input type="text" name="wilayah_kerja"
                            id="edit_wilayah" class="form-control"></div>
                    <div class="form-group"><label>Telepon</label><input type="text" name="telepon" id="edit_telepon"
                            class="form-control" required></div>
                    <div class="form-group"><label>Email</label><input type="email" name="email" id="edit_email"
                            class="form-control" required></div>
                    <div class="form-group"><label>Peta Lokasi</label><textarea name="peta_lokasi" id="edit_peta"
                            class="form-control"></textarea></div>
                    <div class="form-group">
                        <label>Status</label>
                        <select name="status" id="edit_status" class="form-control">
                            <option value="aktif">Aktif</option>
                            <option value="nonaktif">Nonaktif</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Simpan</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- =======================
     SCRIPT CRUD
======================= -->
<script>
$(function () {
    // ===== HAPUS DATA DENGAN KONFIRMASI + ALERT BERHASIL =====
    $(document).on('click', '.delete', function (e) {
        e.preventDefault();
        const form = $(this).closest('.delete-form');
        const actionUrl = form.attr('action');

        Swal.fire({
            title: 'Yakin hapus data ini?',
            text: 'Data yang dihapus tidak dapat dikembalikan!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ya, hapus',
            cancelButtonText: 'Batal',
            reverseButtons: true
        }).then(result => {
            if (result.isConfirmed) {
                $.ajax({
                    url: actionUrl,
                    type: 'POST',
                    success: function () {
                        Swal.fire({
                            icon: 'success',
                            title: 'Berhasil!',
                            text: 'Data berhasil dihapus',
                            timer: 2000,
                            showConfirmButton: false
                        }).then(() => location.reload());
                    },
                    error: function () {
                        Swal.fire('Gagal', 'Terjadi kesalahan saat menghapus data', 'error');
                    }
                });
            }
        });
    });

    // ===== TAMBAH DATA =====
    $('#formTambahSeksi').on('submit', function (e) {
        e.preventDefault();
        $.post($(this).attr('action'), $(this).serialize(), function () {
            $('#tambahSeksiModal').modal('hide');
            Swal.fire({
                icon: 'success',
                title: 'Berhasil!',
                text: 'Data berhasil ditambahkan',
                timer: 2000,
                showConfirmButton: false
            }).then(() => location.reload());
        });
    });

    // ===== TAMPILKAN DATA SAAT EDIT =====
    $(document).on('click', '.edit', function () {
        $('#edit_id').val($(this).data('id'));
        $('#edit_nama').val($(this).data('nama'));
        $('#edit_kepala').val($(this).data('kepala'));
        $('#edit_kode').val($(this).data('kode'));
        $('#edit_alamat').val($(this).data('alamat'));
        $('#edit_kabupaten').val($(this).data('kabupaten'));
        $('#edit_wilayah').val($(this).data('wilayah'));
        $('#edit_telepon').val($(this).data('telepon'));
        $('#edit_email').val($(this).data('email'));
        $('#edit_peta').val($(this).data('peta'));
        $('#edit_status').val($(this).data('status'));
        $('#editSeksiModal').modal('show');
    });

    // ===== TUTUP MODAL EDIT SECARA AMAN =====
    $(document).on('click', '#editSeksiModal [data-dismiss="modal"], #editSeksiModal .close', function (e) {
        e.preventDefault();
        $('#editSeksiModal').modal('hide');
        $('body').removeClass('modal-open');
        $('.modal-backdrop').remove();
    });

    // ===== UPDATE DATA =====
    $('#formEditSeksi').on('submit', function (e) {
        e.preventDefault();
        const id = $('#edit_id').val();
        $.ajax({
            url: `/admin/unit_kerja/update/${id}`,
            method: 'POST',
            data: $(this).serialize(),
            success: () => {
                $('#editSeksiModal').modal('hide');
                Swal.fire({
                    icon: 'success',
                    title: 'Diperbarui!',
                    text: 'Data berhasil diupdate',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => location.reload());
            },
            error: () => Swal.fire('Gagal', 'Terjadi kesalahan saat memperbarui data', 'error')
        });
    });
});
</script>


{% endblock %}